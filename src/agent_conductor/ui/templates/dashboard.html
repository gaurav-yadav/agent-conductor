<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Agent Conductor Dashboard</title>
  <link rel="stylesheet" href="https://unpkg.com/chota@0.9.2/dist/chota.min.css">
  <style>
    body { padding: 1.5rem; }
    .status-ready { color: #2b7a0b; }
    .status-running { color: #b58900; }
    .status-completed { color: #586e75; }
    .status-error { color: #dc322f; }
    .prompt { border-left: 4px solid #b58900; padding-left: 1rem; margin-bottom: 1rem; }
    .approvals { border-left: 4px solid #268bd2; padding-left: 1rem; margin-bottom: 1rem; }
    .spacer { margin-top: 1.5rem; }
    pre { background: #f7f7f7; padding: 0.5rem; }
  </style>
</head>
<body>
  <header class="row">
    <div class="col">
      <h1>Agent Conductor Dashboard</h1>
      <p class="text-secondary">Monitor sessions, respond to prompts, and manage approvals in one place.</p>
    </div>
    <div class="col text-right">
      <button class="button" onclick="refreshDashboard()">Refresh</button>
    </div>
  </header>

  <section>
    <h2>Sessions</h2>
    {% if sessions %}
      {% for session in sessions %}
        <article class="card">
          <header class="card-header">
            <div>
              <strong>{{ session.name }}</strong>
            </div>
            <div>
              <button class="button secondary" onclick="closeSession('{{ session.name }}')">Close session</button>
            </div>
          </header>
          <div class="card-body">
            <table class="striped">
              <thead>
                <tr>
                  <th>Window</th>
                  <th>Terminal ID</th>
                  <th>Provider</th>
                  <th>Status</th>
                  <th>Actions</th>
                </tr>
              </thead>
              <tbody>
                {% for terminal in session.terminals %}
                  <tr>
                    <td>{{ terminal.window_name }}</td>
                    <td><code>{{ terminal.id }}</code></td>
                    <td>{{ terminal.provider }}</td>
                    <td class="status-{{ terminal.status.value | lower }}">{{ terminal.status.value }}</td>
                    <td>
                      {% if not terminal.window_name.startswith('supervisor-') %}
                        <button class="button outline" onclick="closeTerminal('{{ terminal.id }}')">Close</button>
                      {% else %}
                        <em>Supervisor</em>
                      {% endif %}
                    </td>
                  </tr>
                {% endfor %}
              </tbody>
            </table>
            <div class="row">
              <div class="col">
                <label>Launch worker</label>
                <div class="row">
                  <div class="col">
                    <select id="worker-profile-{{ session.name }}">
                      {% for profile in bundled_personas %}
                        <option value="{{ profile }}">{{ profile }}</option>
                      {% endfor %}
                    </select>
                  </div>
                  <div class="col">
                    <button class="button" onclick="spawnWorker('{{ session.name }}')">Spawn</button>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </article>
      {% endfor %}
    {% else %}
      <p>No active sessions. Use <code>acd launch</code> (or <code>agent-conductor launch</code>) to start one.</p>
    {% endif %}
  </section>

  <section class="spacer">
    <h2>Pending Prompts</h2>
    {% set has_prompts = false %}
    {% for supervisor_id, messages in inbox_summary.items() %}
      {% for message in messages %}
        {% if '[PROMPT]' in message.message %}
          {% set has_prompts = true %}
          {% set lines = message.message.split('\n') %}
          {% set response_hint = lines[-1] if lines else '' %}
          {% set worker_id = None %}
          {% if 'acd send ' in response_hint %}
            {% set parts = response_hint.split('acd send ') %}
            {% if parts|length > 1 %}
              {% set tail = parts[1] %}
              {% set worker_id = tail.split(' ')[0] %}
            {% endif %}
          {% elif 'agent-conductor send ' in response_hint %}
            {% set parts = response_hint.split('agent-conductor send ') %}
            {% if parts|length > 1 %}
              {% set tail = parts[1] %}
              {% set worker_id = tail.split(' ')[0] %}
            {% endif %}
          {% elif 'acd s ' in response_hint %}
            {% set parts = response_hint.split('acd s ') %}
            {% if parts|length > 1 %}
              {% set tail = parts[1] %}
              {% set worker_id = tail.split(' ')[0] %}
            {% endif %}
          {% elif 'agent-conductor s ' in response_hint %}
            {% set parts = response_hint.split('agent-conductor s ') %}
            {% if parts|length > 1 %}
              {% set tail = parts[1] %}
              {% set worker_id = tail.split(' ')[0] %}
            {% endif %}
          {% endif %}
          <div class="prompt">
            <p><strong>{{ lines[0] if lines else message.message }}</strong></p>
            {% if lines|length > 1 %}
              <pre>{{ '\n'.join(lines[1:]) }}</pre>
            {% endif %}
            {% if worker_id %}
              <div class="row">
                <div class="col">
                  <input
                    id="prompt-input-{{ message.id }}"
                    type="text"
                    placeholder="Type response (e.g., 1, yes)"
                    onkeydown="promptKeydown(event, '{{ worker_id }}', 'prompt-input-{{ message.id }}')"
                  />
                </div>
                <div class="col">
                  <button
                    class="button primary"
                    onclick="sendPrompt('{{ worker_id }}', 'prompt-input-{{ message.id }}')"
                  >
                    Send
                  </button>
                </div>
              </div>
              <p class="text-secondary" style="margin-top: 0.5rem;">
                Target worker terminal: <code>{{ worker_id }}</code>
              </p>
            {% else %}
              <p class="text-secondary">
                Unable to determine the worker terminal ID; respond from the supervisor terminal.
              </p>
            {% endif %}
          </div>
        {% endif %}
      {% endfor %}
    {% endfor %}
    {% if not has_prompts %}
      <p class="text-secondary">No worker prompts awaiting attention.</p>
    {% endif %}
  </section>

  <section class="spacer">
    <h2>Pending Approvals</h2>
    {% if approvals %}
      {% for approval in approvals %}
        <div class="approvals">
          <p><strong>Terminal:</strong> {{ approval.terminal_id }} | <strong>Command:</strong> <code>{{ approval.command_text }}</code></p>
          <button class="button primary" onclick="approve({{ approval.id }})">Approve</button>
          <button class="button secondary" onclick="deny({{ approval.id }})">Deny</button>
        </div>
      {% endfor %}
    {% else %}
      <p class="text-secondary">No pending approvals.</p>
    {% endif %}
  </section>

  <script>
    async function refreshDashboard() {
      window.location.reload();
    }

    async function spawnWorker(sessionName) {
      const select = document.getElementById(`worker-profile-${sessionName}`);
      const profile = select.value;
      await fetch(`/sessions/${sessionName}/terminals`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ provider: 'claude_code', role: 'worker', agent_profile: profile })
      });
      refreshDashboard();
    }

    async function closeSession(sessionName) {
      if (!confirm(`Close session ${sessionName}?`)) return;
      await fetch(`/sessions/${sessionName}`, { method: 'DELETE' });
      refreshDashboard();
    }

    async function closeTerminal(terminalId) {
      if (!confirm(`Close terminal ${terminalId}?`)) return;
      await fetch(`/terminals/${terminalId}`, { method: 'DELETE' });
      refreshDashboard();
    }

    async function sendPrompt(workerId, inputId) {
      const input = document.getElementById(inputId);
      if (!input) {
        alert('Unable to locate prompt input field.');
        return;
      }
      const message = input.value.trim();
      if (!message) {
        alert('Enter a response before sending.');
        return;
      }
      const response = await fetch(`/terminals/${workerId}/input`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ message }),
      });
      if (!response.ok) {
        let detail = await response.text();
        try {
          const parsed = JSON.parse(detail);
          detail = parsed.detail || detail;
        } catch (err) {
          // response was not JSON; keep raw text
        }
        alert(`Failed to send response: ${detail}`);
        return;
      }
      input.value = '';
      refreshDashboard();
    }

    function promptKeydown(event, workerId, inputId) {
      if (event.key === 'Enter' && !event.shiftKey) {
        event.preventDefault();
        sendPrompt(workerId, inputId);
      }
    }

    async function approve(id) {
      await fetch(`/approvals/${id}/approve`, { method: 'POST' });
      refreshDashboard();
    }

    async function deny(id) {
      const reason = prompt('Optional reason for denial:');
      await fetch(`/approvals/${id}/deny`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ reason })
      });
      refreshDashboard();
    }
  </script>
</body>
</html>
